# 数据集表结构重构说明

## 重构概述

**时间**：2025-11-25  
**范围**：Dataset 数据集相关表结构与代码

## 重构目标

将原有的分散式数据集配置（仅有子表）重构为标准的主-从表结构，提升数据一致性和管理效率。

---

## 表结构变更

### 变更前（旧结构）

```
sys_portal_dataset (数据集关联表配置，使用 tableId:String 关联)
sys_portal_dataset_column (数据集列配置，使用 tableId:String 关联)
```

**问题**：
- `tableId` (String) 分散在两个子表中，缺乏主记录
- 无法为 `tableId` 提供唯一性约束和集中管理
- 不利于与 `sys_portal` 的 `reference_id` 进行稳定关联

### 变更后（新结构）

```
sys_dataset (主表，id:Long 主键)
    ├─ 1:N → sys_dataset_table (关联表配置，dataset_id:Long 关联主表)
    └─ 1:N → sys_dataset_column (列配置，dataset_id:Long 关联主表)
```

**改进**：
- ✅ 新增主表 `sys_dataset`，使用自增主键 `id`（Long）作为唯一标识
- ✅ 子表通过 `dataset_id` (Long) 关联主表，性能更优（bigint > varchar）
- ✅ 字段语义化：`dataset_sql` → `table_sql`，`dataset_alias` → `table_alias`
- ✅ 预留 `reference_id` 字段用于未来与 `sys_portal` 的关联

---

## 表字段对照

### 1. sys_dataset (新增主表)

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | bigint(20) | 数据集ID（主键，自增） |
| `dataset_name` | varchar(100) | 数据集名称 |
| `data_source` | varchar(50) | 数据源配置名称 |
| `reference_id` | bigint(20) | 关联引用ID（预留） |
| `remark` | text | 备注 |
| `create_by/at/update_by/at` | 审计字段 | 自动填充 |
| `valid` | char(1) | 有效性 |

### 2. sys_dataset_table (重构自 sys_portal_dataset)

| 旧字段 | 新字段 | 类型变更 | 说明 |
|--------|--------|----------|------|
| `table_id` | `dataset_id` | String → Long | 关联数据集ID |
| `dataset_order` | `table_order` | Integer | 表顺序 |
| `dataset_sql` | `table_sql` | text | 关联表SQL |
| `dataset_alias` | `table_alias` | varchar(50) | 表别名 |
| `join_type` | `join_type` | varchar(20) | JOIN类型 |
| `join_condition` | `join_condition` | text | ON条件 |

### 3. sys_dataset_column (重构自 sys_portal_dataset_column)

| 旧字段 | 新字段 | 类型变更 | 说明 |
|--------|--------|----------|------|
| `table_id` | `dataset_id` | String → Long | 关联数据集ID |
| `column_sql` | `column_sql` | text | 字段SQL表达式 |
| `column_alias` | `column_alias` | varchar(100) | 字段别名 |
| `is_aggregate` | `is_aggregate` | char(1) | 是否聚合字段 |
| `display_order` | `display_order` | Integer | 显示排序 |
| `is_visible` | `is_visible` | char(1) | 是否显示 |

---

## 代码变更清单

### 1. 新增文件（24个）

#### SysDataset（8个文件）
- ✅ `SysDataset.java` - Entity
- ✅ `SysDatasetMapper.java` - Mapper接口
- ✅ `SysDatasetMapper.xml` - MapperXML
- ✅ `SysDatasetSchema.java` - Schema（DDL）
- ✅ `SysDatasetService.java` - Repository Service
- ✅ `SysDatasetVO.java` - VO
- ✅ `SysDatasetPortalService.java` - Portal Service
- ✅ `SysDatasetPortalController.java` - Controller

#### SysDatasetTable（8个文件）
- ✅ `SysDatasetTable.java` - Entity
- ✅ `SysDatasetTableMapper.java` - Mapper接口
- ✅ `SysDatasetTableMapper.xml` - MapperXML
- ✅ `SysDatasetTableSchema.java` - Schema（DDL）
- ✅ `SysDatasetTableService.java` - Repository Service
- ✅ `SysDatasetTableVO.java` - VO
- ✅ `SysDatasetTablePortalService.java` - Portal Service
- ✅ `SysDatasetTablePortalController.java` - Controller

#### SysDatasetColumn（8个文件）
- ✅ `SysDatasetColumn.java` - Entity
- ✅ `SysDatasetColumnMapper.java` - Mapper接口
- ✅ `SysDatasetColumnMapper.xml` - MapperXML
- ✅ `SysDatasetColumnSchema.java` - Schema（DDL）
- ✅ `SysDatasetColumnService.java` - Repository Service
- ✅ `SysDatasetColumnVO.java` - VO
- ✅ `SysDatasetColumnPortalService.java` - Portal Service
- ✅ `SysDatasetColumnPortalController.java` - Controller

### 2. 重构文件（5个）

#### VO类更新
- ✅ `DatasetConfigReq.java` - `tableId:String` → `datasetId:Long`
- ✅ `DatasetConfigRes.java` - `datasets` → `tables`，`tableId:String` → `datasetId:Long`
- ✅ `DatasetColumnReq.java` - `tableId:String` → `datasetId:Long`

#### Service类更新
- ✅ `PortalDatasetSqlUtil.java` - 所有方法参数从 `SysPortalDataset` → `SysDatasetTable`
- ✅ `DatasetConfigService.java` - 完整重构所有方法

### 3. Repository Service扩展

- ✅ `SysDatasetTableService.java` - 新增 `getByDatasetId()` 和 `deleteByDatasetId()`
- ✅ `SysDatasetColumnService.java` - 新增 `getByDatasetId()` 和 `deleteByDatasetId()`

---

## API路径变更

| 功能 | 旧路径 | 新路径 |
|------|--------|--------|
| 数据集主表 | - | `/web/dataset` |
| 数据集关联表 | - | `/web/dataset/table` |
| 数据集列配置 | - | `/web/dataset/column` |

---

## 数据迁移方案（可选）

由于当前**尚未投入使用**，无需数据迁移。如未来需要从旧表迁移数据，参考 SQL：

```sql
-- 1. 从 sys_portal_dataset 提取唯一 tableId 生成主表记录
INSERT INTO sys_dataset (dataset_name, data_source, remark, create_by, create_at, valid)
SELECT DISTINCT 
    table_id AS dataset_name,
    data_source,
    '从旧表迁移' AS remark,
    'SYSTEM' AS create_by,
    NOW() AS create_at,
    '1' AS valid
FROM sys_portal_dataset;

-- 2. 迁移关联表配置
INSERT INTO sys_dataset_table (dataset_id, data_source, table_order, table_sql, table_alias, join_type, join_condition, remark, create_by, create_at)
SELECT 
    d.id AS dataset_id,
    p.data_source,
    p.dataset_order AS table_order,
    p.dataset_sql AS table_sql,
    p.dataset_alias AS table_alias,
    p.join_type,
    p.join_condition,
    p.remark,
    p.create_by,
    p.create_at
FROM sys_portal_dataset p
LEFT JOIN sys_dataset d ON p.table_id = d.dataset_name;

-- 3. 迁移列配置
INSERT INTO sys_dataset_column (dataset_id, column_sql, column_alias, is_aggregate, display_order, is_visible, remark, create_by, create_at)
SELECT 
    d.id AS dataset_id,
    c.column_sql,
    c.column_alias,
    c.is_aggregate,
    c.display_order,
    c.is_visible,
    c.remark,
    c.create_by,
    c.create_at
FROM sys_portal_dataset_column c
LEFT JOIN sys_dataset d ON c.table_id = d.dataset_name;
```

---

## 影响范围

### ✅ 已完成
- 新表 DDL 定义（Schema）
- 全套代码生成（Entity、Mapper、Service、VO、Controller）
- 工具类 `PortalDatasetSqlUtil` 重构
- 业务服务 `DatasetConfigService` 重构
- VO 类字段类型调整

### ⚠️ 待确认
- 旧表 `sys_portal_dataset` 和 `sys_portal_dataset_column` 是否保留？
  - **建议**：标记为 `@Deprecated`，待确认无业务依赖后删除

---

## 回滚方案

如需回滚，执行以下操作：

1. 删除新表：
   ```sql
   DROP TABLE IF EXISTS sys_dataset_column;
   DROP TABLE IF EXISTS sys_dataset_table;
   DROP TABLE IF EXISTS sys_dataset;
   ```

2. 恢复旧代码（使用 Git）：
   ```bash
   git checkout HEAD~1 -- core/forge/src/main/java/com/bidr/forge/
   ```

---

## 技术亮点

1. **主键优化**：使用 `id:Long` 自增主键替代 `tableId:String`，性能提升显著
2. **关系清晰**：标准主-从表设计，符合数据库范式
3. **扩展性强**：预留 `reference_id` 字段，便于未来与其他模块集成
4. **语义化命名**：字段命名更准确（如 `table_sql` vs `dataset_sql`）
5. **代码规范**：严格遵循 `SQL代码生成指南.md` 规范

---

## 验证清单

- [ ] 编译通过无错误
- [ ] 数据库表自动创建成功
- [ ] Swagger API 文档正常显示
- [ ] CRUD 接口测试通过
- [ ] SQL 解析功能正常
- [ ] 排序功能正常（`table_order`、`display_order`）

---

## 后续计划

1. 完成功能测试
2. 前端对接联调
3. 确认旧表是否可以删除
4. 更新相关业务文档

---

**重构完成时间**：2025-11-25  
**执行人**：Sharp  
**影响模块**：forge
